<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Registration</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/">Register new user</a></li>
                <li><a href="/users">Show all users</a></li>

            </ul>

        </nav>
    </header>

    <form>
        <h4>Registration</h4>
        <input name="name" placeholder="Name" />
        <input name="email" placeholder="Email" />
        <input name="phone" placeholder="Phone" />
        <button type="submit">Submit</button>
    </form>

    <script>
        const form = document.querySelector('form');    

        window.onload = fetchUserAndSetToForm;
        async function fetchUser(id) { 

            const response = await fetch(`api/users/${id}`);
            const user = await response.json();
            return user;
        }

        async function setUserToForm(user) {
            document.querySelector('input[name="name"]').value = user.name;
            document.querySelector('input[name="email"]').value = user.email;
            document.querySelector('input[name="phone"]').value = user.phone;
        }

        async function fetchUserAndSetToForm() {

            const url = new URL(window.location.href);
            const id = url.searchParams.get('id');

            if (!id) {
                console.error('User ID is not provided');
                return;
            }

            const user = await fetchUser(id);
            console.log(user)
            setUserToForm(user);
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const url = new URL(window.location.href);
            const id = url.searchParams.get('id');

            const user = {
                name: document.querySelector('input[name="name"]').value,
                email: document.querySelector('input[name="email"]').value,
                phone: document.querySelector('input[name="phone"]').value
            };

          if(id) {
              user.id = id;
              await updateUser(user);
          } else {
              await saveUser(user);
          }


        });

        async function saveUser(user) {
            const response = await fetch('api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(user)
            });

            if (response.ok) {
                alert('User created successfully');
            } else {
                alert('Failed to create user');
            }
        }

        async function updateUser(user) {
            const response = await fetch(`api/users/${user.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(user)
            });

            if (response.ok) {
                alert('User updated successfully');
            } else {
                alert('Failed to update user');
            }
        }

    </script>

</body>
</html>